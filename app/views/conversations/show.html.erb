<%= turbo_stream_from @conversation %>

<div class="h-screen flex bg-gray-100">
  <!-- Chat Panel (Left Side) -->
  <div class="flex-1 flex flex-col">
    <!-- Header -->
    <div class="bg-white shadow-sm p-4 border-b">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-xl font-semibold"><%= @conversation.character.name %></h1>
          <p class="text-gray-600 text-sm"><%= @conversation.character.description %></p>
        </div>
        <%= link_to "â† Back to Conversations", conversations_path,
                    class: "text-blue-600 hover:text-blue-800" %>
      </div>
    </div>

    <!-- Messages Area -->
    <div class="flex-1 overflow-y-auto p-4 space-y-4" id="messages">
      <% @messages.each do |message| %>
        <%= render "messages/message", message: message %>
      <% end %>
    </div>

    <!-- Message Input -->
    <div class="bg-white border-t p-4">
      <%= form_with url: send_message_conversation_path(@conversation),
                    method: :post,
                    class: "flex gap-2" do |form| %>
        <%= form.text_area :message,
                           placeholder: "Type your message...",
                           rows: 2,
                           class: "flex-1 border rounded-lg p-3 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500",
                           required: true %>
        <%= form.submit "Send",
                        class: "bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors self-end" %>
      <% end %>
    </div>
  </div>

  <!-- Character Display Panel (Right Side) -->
  <div class="w-96 bg-white shadow-lg" id="character-display">
    <%= render "character_display", conversation: @conversation, current_state: @current_state %>
  </div>
</div>

<script>
  // Auto-scroll messages to bottom
  const messagesContainer = document.getElementById('messages');
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
  
  // Auto-scroll on new messages
  document.addEventListener('turbo:morph', () => {
    console.log("Turbo morph detected", messagesContainer.scrollHeight, messagesContainer.scrollTop);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  });

  document.addEventListener('turbo:submit-start', () => {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  });
</script>
