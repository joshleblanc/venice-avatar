<div class="md:h-full flex flex-col">
  <!-- Visual Novel Scene Area -->
  <div class="md:flex-1 relative bg-gradient-to-b from-slate-800 to-slate-900 flex flex-col">
    <!-- Scene Image/Video Container -->
    <div class="md:flex-1 flex items-center justify-center relative min-h-[240px] p-4">
      <% scene_image = conversation.last_scene_image %>
      <% latest_video = conversation.video_generations.completed.order(created_at: :desc).first %>
      
      <% if latest_video&.video&.attached? %>
        <video autoplay loop muted playsinline
               class="max-w-full max-h-full object-contain rounded-xl shadow-2xl shadow-violet-500/10">
          <%= tag.source src: url_for(latest_video.video), type: "video/mp4" %>
        </video>
      <% elsif scene_image %>
        <%= image_tag scene_image,
                      alt: "#{conversation.character.name} scene",
                      class: "max-w-full max-h-full object-contain rounded-xl shadow-2xl shadow-violet-500/10" %>
      <% else %>
        <!-- Initial Generation - Vertically Centered -->
        <div class="flex items-center justify-center">
          <div class="glass rounded-2xl p-8 text-center glow-violet">
            <div class="w-12 h-12 mx-auto mb-4 rounded-xl bg-gradient-to-br from-violet-500 to-indigo-600 flex items-center justify-center">
              <svg class="animate-spin w-6 h-6 text-white" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </div>
            <p class="text-sm text-slate-300">Generating scene...</p>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Updating Notification - Small Footnote -->
    <% if @conversation&.scene_generating %>
      <div class="text-center py-2">
        <div class="inline-flex items-center gap-2 px-3 py-1.5 glass rounded-full text-xs text-slate-400">
          <svg class="animate-spin w-3.5 h-3.5" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span>Updating scene...</span>
        </div>
      </div>
    <% end %>

    <!-- Character Info Panel - Simplified -->
    <div class="glass border-t border-slate-700/50">
      <div class="max-w-sm mx-auto p-5 space-y-4">
        <div class="text-center">
          <h3 class="font-semibold text-lg text-white"><%= conversation.character.name %></h3>
          <p class="text-sm text-slate-400 flex items-center justify-center gap-1.5">
            <span class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></span>
            Active
          </p>
        </div>

        <!-- Character Tags - Centered -->
        <% if conversation.character.tag_list.any? %>
          <div class="flex flex-wrap justify-center gap-1.5">
            <% conversation.character.tag_list.first(3).each do |tag| %>
              <span class="px-2.5 py-1 bg-slate-700/50 text-slate-300 text-xs rounded-full border border-slate-600/50"><%= tag %></span>
            <% end %>
          </div>
        <% end %>

        <div class="flex flex-col items-center gap-3">
          <%= form_with model: conversation,
                        url: image_style_conversation_path(conversation),
                        method: :patch,
                        local: true,
                        class: "flex items-center gap-2" do |f| %>
            <%= f.label :image_style, "Style", class: "text-xs text-slate-400" %>
            <%= f.select :image_style,
                         options_for_select(@image_styles, @selected_image_style),
                         {},
                         class: "text-sm bg-slate-800/50 border border-slate-600/50 text-white rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-violet-500/50",
                         data: { controller: "autosubmit", action: "change->autosubmit#submit" } %>
          <% end %>

          <div class="flex items-center gap-2">
            <%= button_to regenerate_scene_conversation_path(conversation),
                          method: :post,
                          class: "inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-xl bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-violet-500 hover:to-indigo-500 text-white shadow-lg shadow-violet-500/25 hover:shadow-violet-500/40 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed",
                          disabled: conversation.scene_generating || !conversation.user.venice_key_valid? do %>
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              Regenerate
            <% end %>

            <% video_in_progress = conversation.video_generations.in_progress.exists? %>
            <%= button_to conversation_video_generations_path(conversation),
                          method: :post,
                          class: "inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-xl bg-gradient-to-r from-pink-600 to-rose-600 hover:from-pink-500 hover:to-rose-500 text-white shadow-lg shadow-pink-500/25 hover:shadow-pink-500/40 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed",
                          disabled: !conversation.scene_image.attached? || video_in_progress || !conversation.user.venice_key_valid?,
                          title: video_in_progress ? "Video generation in progress" : "Generate video from scene" do %>
              <% if video_in_progress %>
                <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Generating...
              <% else %>
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
                Video
              <% end %>
            <% end %>
          </div>
        </div>

        <!-- Video Generation Status -->
        <% latest_video = conversation.video_generations.order(created_at: :desc).first %>
        <% if latest_video&.in_progress? %>
          <div class="glass-light rounded-xl p-3" data-controller="video-status" data-video-status-url-value="<%= status_conversation_video_generation_path(conversation, latest_video) %>" data-video-status-interval-value="5000">
            <div class="flex items-center gap-3">
              <div class="flex-shrink-0">
                <svg class="animate-spin w-5 h-5 text-pink-400" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </div>
              <div class="flex-1 min-w-0">
                <p class="text-xs text-slate-300">Generating video...</p>
                <div class="mt-1 w-full bg-slate-700 rounded-full h-1.5">
                  <div class="bg-gradient-to-r from-pink-500 to-rose-500 h-1.5 rounded-full transition-all duration-500" style="width: <%= latest_video.progress_percentage %>%" data-video-status-target="progress"></div>
                </div>
              </div>
              <span class="text-xs text-slate-400" data-video-status-target="percentage"><%= latest_video.progress_percentage %>%</span>
            </div>
          </div>
        <% elsif latest_video&.completed? && latest_video.video.attached? %>
          <div class="glass-light rounded-xl p-3">
            <div class="flex items-center justify-between">
              <span class="text-xs text-emerald-400 flex items-center gap-1.5">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                Video ready
              </span>
              <%= link_to url_for(latest_video.video), 
                          target: "_blank",
                          class: "text-xs text-pink-400 hover:text-pink-300 flex items-center gap-1" do %>
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                Download
              <% end %>
            </div>
          </div>
        <% elsif latest_video&.failed? %>
          <div class="glass-light rounded-xl p-3 border border-red-500/20">
            <p class="text-xs text-red-400">Video generation failed: <%= latest_video.error %></p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
